<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Hub | God Mode</title>
    <style>
        :root { --main: #0088cc; --glass: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.15); }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0b0e14; height: 100vh; display: flex; align-items: center; justify-content: center; color: white; overflow: hidden; }

        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.8s; }
        .logo-pulse { width: 60px; height: 60px; background: var(--main); border-radius: 18px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        #auth-ui { background: white; color: black; padding: 30px; border-radius: 25px; text-align: center; width: 320px; display: none; }
        #auth-ui input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .app-card { width: 100%; max-width: 450px; height: 95vh; background: var(--glass); backdrop-filter: blur(40px); border: 1px solid var(--border); border-radius: 35px; display: none; flex-direction: column; overflow: hidden; position: relative; }
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        
        .msg-row { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 5px; position: relative; }
        .msg-row.me { flex-direction: row-reverse; }
        .pfp { width: 35px; height: 35px; border-radius: 10px; background: #333; cursor: pointer; }
        
        .bubble { padding: 10px 14px; border-radius: 18px; background: rgba(255,255,255,0.1); max-width: 75%; word-wrap: break-word; cursor: pointer; position: relative; transition: 0.2s; }
        .bubble:hover { background: rgba(255,255,255,0.15); }
        .me .bubble { background: var(--main); }

        .del-btn { position: absolute; top: -5px; right: -5px; background: #ff3b30; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; display: none; }
        .msg-row.me:hover .del-btn { display: block; }

        .reply-preview { background: rgba(0,0,0,0.5); padding: 8px 15px; border-left: 4px solid var(--main); display: none; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .reply-box { font-size: 0.75rem; background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 8px; margin-bottom: 5px; border-left: 2px solid #fff; opacity: 0.8; }

        .input-bar { padding: 15px; background: rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 5px; }
        .input-row { display: flex; gap: 8px; align-items: center; }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .voice-btn.recording { background: #ff3b30; animation: pulse 1s infinite; }

        #settings-ui { position: absolute; inset: 0; background: #12151c; z-index: 10; padding: 30px; display: none; flex-direction: column; gap: 15px; }
        .close-btn { align-self: flex-end; cursor: pointer; font-size: 1.5rem; }
        img.chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="loader"><div class="logo-pulse"></div><p style="font-size:0.7rem; margin-top:15px;">INITIALIZING HUB</p></div>

    <div id="auth-ui">
        <h3 id="auth-title">Login</h3>
        <input type="text" id="userIn" placeholder="Username">
        <input type="password" id="passIn" placeholder="Password">
        <button id="auth-btn" onclick="handleAuth()" style="width:100%; padding:12px; background:var(--main); color:white; border:none; border-radius:8px;">Enter Hub</button>
        <p onclick="toggleAuth()" id="toggle-txt" style="font-size:12px; cursor:pointer; margin-top:10px; color:var(--main);">Need an account? Sign Up</p>
    </div>

    <div class="app-card" id="app">
        <header style="padding:15px; border-bottom:1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <span style="width: 20px;"></span>
            <strong>Cloud Hub</strong>
            <span onclick="toggleSettings(true)" style="cursor: pointer;">‚öôÔ∏è</span>
        </header>

        <div id="settings-ui">
            <span class="close-btn" onclick="toggleSettings(false)">√ó</span>
            <h2>Settings</h2>
            <label>Display Name</label>
            <input type="text" id="set-name" style="padding:10px; border-radius:8px; border:none; background:#222; color:white;">
            <label>Avatar Seed</label>
            <input type="text" id="set-avatar" style="padding:10px; border-radius:8px; border:none; background:#222; color:white;">
            <button onclick="saveSettings()" style="padding:12px; background:var(--main); color:white; border:none; border-radius:8px; margin-top:10px;">Save Changes</button>
        </div>

        <div id="chat-flow"></div>

        <div class="reply-preview" id="replyPreview">
            <div id="replyText" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></div>
            <span onclick="cancelReply()" style="cursor:pointer; font-weight:bold;">√ó</span>
        </div>

        <div class="input-bar">
            <div class="input-row">
                <button onclick="document.getElementById('imgInput').click()" class="icon-btn">üñºÔ∏è</button>
                <input type="file" id="imgInput" hidden accept="image/*" onchange="uploadImage(this)">
                
                <input type="text" id="msgInput" placeholder="Type message..." style="flex:1; background:rgba(255,255,255,0.1); border:none; padding:12px; border-radius:20px; color:white; outline:none;">
                
                <button id="voiceBtn" class="icon-btn voice-btn">üé§</button>
            </div>
        </div>
    </div>

    <script>
        let isSignup = false;
        let myName = "";
        let myAvatar = "";
        let lastCount = 0;
        let replyingTo = null;
        let mediaRecorder;
        let chunks = [];

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('auth-ui').style.display = 'block';
            }, 1000);
        };

        function toggleAuth() {
            isSignup = !isSignup;
            document.getElementById('auth-title').innerText = isSignup ? "Sign Up" : "Login";
            document.getElementById('auth-btn').innerText = isSignup ? "Create Account" : "Enter Hub";
            document.getElementById('toggle-txt').innerText = isSignup ? "Have an account? Login" : "Need an account? Sign Up";
        }

        async function handleAuth() {
            const username = document.getElementById('userIn').value;
            const password = document.getElementById('passIn').value;
            const url = isSignup ? '/api/signup' : '/api/login';
            myAvatar = `https://api.dicebear.com/7.x/bottts/svg?seed=${username}`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password, avatar: myAvatar })
                });
                const data = await res.json();
                if(data.success) {
                    myName = username;
                    document.getElementById('set-name').value = myName;
                    document.getElementById('auth-ui').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    setInterval(sync, 1000);
                    setupVoice();
                } else { alert(data.msg); }
            } catch(e) { alert("Server error. Check server.js"); }
        }

        async function sync() {
            const res = await fetch('/api/history');
            const data = await res.json();
            const flow = document.getElementById('chat-flow');
            
            if(data.history.length !== lastCount) {
                flow.innerHTML = data.history.map((m) => `
                    <div class="msg-row ${m.user === myName ? 'me' : ''}">
                        <img src="${m.avatar}" class="pfp">
                        <div class="bubble" onclick="setReply('${m.user}', '${m.type === 'text' ? m.content : m.type + ' message'}')">
                            ${m.user === myName ? `<button class="del-btn" onclick="deleteMsg('${m.id}')">√ó</button>` : ''}
                            <small style="font-size:9px; opacity:0.5; display:block;">${m.user}</small>
                            ${m.reply ? `<div class="reply-box"><strong>${m.reply.user}</strong>: ${m.reply.content}</div>` : ''}
                            
                            ${m.type === 'text' ? m.content : 
                              m.type === 'image' ? `<img src="${m.content}" class="chat-img">` :
                              `<audio controls src="${m.content}" style="width:180px;"></audio>`}
                        </div>
                    </div>
                `).join('');
                lastCount = data.history.length;
                flow.scrollTop = flow.scrollHeight;
            }
        }

        async function deleteMsg(id) {
            if(!confirm("Delete this message?")) return;
            await fetch('/api/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, user: myName })
            });
            sync();
        }

        async function uploadImage(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'image', content: reader.result, user: myName, avatar: myAvatar, reply: replyingTo })
                });
                cancelReply();
                sync();
            };
        }

        function setReply(user, content) {
            replyingTo = { user, content };
            document.getElementById('replyPreview').style.display = 'flex';
            document.getElementById('replyText').innerText = `Replying to ${user}: ${content}`;
            document.getElementById('msgInput').focus();
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyPreview').style.display = 'none';
        }

        document.getElementById('msgInput').onkeydown = async (e) => {
            if(e.key === 'Enter' && e.target.value) {
                const content = e.target.value;
                e.target.value = '';
                const payload = { type: 'text', content, user: myName, avatar: myAvatar, reply: replyingTo };
                cancelReply();
                await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                sync();
            }
        };

        function toggleSettings(show) { document.getElementById('settings-ui').style.display = show ? 'flex' : 'none'; }

        function saveSettings() {
            myName = document.getElementById('set-name').value;
            const seed = document.getElementById('set-avatar').value;
            if(seed) myAvatar = `https://api.dicebear.com/7.x/bottts/svg?seed=${seed}`;
            toggleSettings(false);
        }

        async function setupVoice() {
            const btn = document.getElementById('voiceBtn');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = async () => {
                        await fetch('/api/save', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ type: 'audio', content: reader.result, user: myName, avatar: myAvatar, reply: replyingTo })
                        });
                        cancelReply();
                        chunks = [];
                        sync();
                    };
                };
                btn.onmousedown = () => { chunks = []; mediaRecorder.start(); btn.classList.add('recording'); };
                btn.onmouseup = () => { mediaRecorder.stop(); btn.classList.remove('recording'); };
            } catch(e) { console.log("Mic access denied"); }
        }
    </script>
</body>
</html>
