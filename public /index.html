<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Hub | God Mode</title>
    <style>
        :root { --main: #0088cc; --glass: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.15); }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0b0e14; height: 100vh; display: flex; align-items: center; justify-content: center; color: white; overflow: hidden; background-size: cover; background-position: center; }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.8s; }
        .logo-pulse { width: 60px; height: 60px; background: var(--main); border-radius: 18px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        /* APP */
        .app-card { width: 100%; max-width: 450px; height: 95vh; background: var(--glass); backdrop-filter: blur(40px); border: 1px solid var(--border); border-radius: 35px; display: none; flex-direction: column; overflow: hidden; }
        header { padding: 15px 20px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg-row { display: flex; gap: 10px; align-items: flex-end; position: relative; }
        .msg-row.me { flex-direction: row-reverse; }
        .pfp { width: 35px; height: 35px; border-radius: 10px; border: 1.5px solid var(--border); }
        .bubble { padding: 10px 14px; border-radius: 18px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); max-width: 75%; cursor: pointer; }
        .me .bubble { background: var(--main); border: none; }
        
        .reply-box { font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; border-left: 3px solid var(--main); margin-bottom: 5px; }
        #reply-bar { display: none; padding: 10px; background: rgba(0,0,0,0.5); border-top: 1px solid var(--border); justify-content: space-between; font-size: 0.8rem; }
        
        .input-bar { padding: 15px; background: rgba(0,0,0,0.4); display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 12px 15px; border-radius: 20px; color: white; outline: none; }
        .voice-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--main); color: white; cursor: pointer; }
        .voice-btn.recording { background: #ff3b30; animation: pulse 1s infinite; }

        /* AVATAR PICKER */
        .avatar-picker { display: flex; gap: 10px; justify-content: center; margin: 15px 0; }
        .avatar-picker img { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .avatar-picker img.selected { border-color: var(--main); transform: scale(1.1); }

        #login-ui { background: white; color: black; padding: 30px; border-radius: 25px; text-align: center; width: 300px; display: none; }
        .status-light { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; display: inline-block; box-shadow: 0 0 5px #4ade80; }
        .status-light.off { background: red; box-shadow: 0 0 5px red; }
    </style>
</head>
<body>

    <div id="loader"><div class="logo-pulse"></div><p style="font-size:0.7rem; margin-top:15px;">INITIALIZING HUB</p></div>

    <div id="login-ui">
        <h3>Join Hub</h3>
        <div class="avatar-picker" id="picker">
            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=1" onclick="sel(this)" class="selected">
            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=2" onclick="sel(this)">
            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=3" onclick="sel(this)">
        </div>
        <input type="text" id="userInput" placeholder="Name" style="width:100%; padding:10px; box-sizing:border-box;">
        <button onclick="join()" style="width:100%; margin-top:10px; padding:10px; background:var(--main); color:white; border:none; border-radius:8px;">Connect</button>
    </div>

    <div class="app-card" id="app">
        <header>
            <strong id="groupName">Cloud Hub</strong>
            <div><span id="light" class="status-light"></span> ‚öôÔ∏è</div>
        </header>
        <div id="chat-flow"></div>
        <div id="reply-bar"><span id="reply-text">Replying...</span><span onclick="cancelReply()">‚úï</span></div>
        <div class="input-bar">
            <input type="text" id="msgInput" placeholder="Message..." onkeydown="if(event.key==='Enter')sendText()">
            <button id="voiceBtn" class="voice-btn">üé§</button>
        </div>
    </div>

    <script>
        let myName = localStorage.getItem('chat_name');
        let myAvatar = localStorage.getItem('chat_pfp') || "https://api.dicebear.com/7.x/bottts/svg?seed=1";
        let lastCount = 0;
        let activeReply = null;
        let mediaRecorder;
        let chunks = [];

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                if (myName) startApp(); else document.getElementById('login-ui').style.display = 'block';
            }, 2500);
        };

        function sel(el) { 
            document.querySelectorAll('.avatar-picker img').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected'); 
            myAvatar = el.src; 
        }

        async function join() {
            const n = document.getElementById('userInput').value;
            if(!n) return;
            myName = n;
            localStorage.setItem('chat_name', n);
            localStorage.setItem('chat_pfp', myAvatar);
            startApp();
        }

        async function startApp() {
            await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: myName, avatar: myAvatar })});
            document.getElementById('login-ui').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            setupVoice();
            setInterval(sync, 1500);
        }

        function setupReply(id, text, user) {
            activeReply = id;
            document.getElementById('reply-bar').style.display = 'flex';
            document.getElementById('reply-text').innerText = `Replying to ${user}`;
        }

        function cancelReply() { activeReply = null; document.getElementById('reply-bar').style.display = 'none'; }

        async function sendText() {
            const i = document.getElementById('msgInput');
            if(!i.value) return;
            await fetch('/api/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'text', content: i.value, replyTo: activeReply }) });
            i.value = ''; cancelReply();
        }

        async function setupVoice() {
            const btn = document.getElementById('voiceBtn');
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(chunks));
                reader.onloadend = async () => {
                    await fetch('/api/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'audio', content: reader.result }) });
                    sync();
                };
                chunks = [];
            };
            btn.onmousedown = () => { mediaRecorder.start(); btn.classList.add('recording'); };
            btn.onmouseup = () => { mediaRecorder.stop(); btn.classList.remove('recording'); };
        }

        async function sync() {
            const res = await fetch('/api/history');
            const data = await res.json();
            const flow = document.getElementById('chat-flow');

            const setRes = await fetch('/api/settings');
            const settings = await setRes.json();
            document.getElementById('groupName').innerText = settings.groupName;
            if(settings.wallpaper) document.body.style.backgroundImage = `url('${settings.wallpaper}')`;

            if (data.history.length !== lastCount) {
                flow.innerHTML = data.history.map(m => {
                    const r = m.replyTo ? data.history.find(x => x.id === m.replyTo) : null;
                    return `
                    <div class="msg-row ${m.user === myName ? 'me' : ''}">
                        <img src="${m.avatar}" class="pfp">
                        <div class="bubble" onclick="setupReply('${m.id}', '${m.content}', '${m.user}')">
                            <div style="font-size:0.6rem; font-weight:bold; opacity:0.5; margin-bottom:3px;">${m.user}</div>
                            ${r ? `<div class="reply-box"><b>${r.user}:</b> ${r.content.substring(0,20)}...</div>` : ''}
                            ${m.type === 'text' ? m.content : `<audio controls style="width:180px; filter:invert(1);" src="${m.content}"></audio>`}
                        </div>
                    </div>`;
                }).join('');
                lastCount = data.history.length;
                flow.scrollTop = flow.scrollHeight;
            }
        }
    </script>
</body>
</html>
